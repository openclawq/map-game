# 地理问答项目设计与实现说明（mapproject）

## 1. 项目目标
本项目是一个纯前端地理问答游戏，核心目标是：
- 在中国/世界地图上进行区域点击与城市定位答题。
- 同时兼顾桌面与移动设备（手机、平板）的可玩性。
- 在无后端条件下提供难度设置、成绩记录、分享与复盘。

## 2. 技术架构
- 前端：`HTML + CSS + JavaScript`（无构建步骤）。
- 地图渲染：`D3.js v7`。
- 数据：`GeoJSON`（地图边界）+ `JSON`（城市坐标/国家元数据）。
- 测试：`Playwright`（E2E）。

代码分层：
- `index.html`：页面结构、模式入口、设置项、操作区、结果页。
- `css/style.css`：视觉风格、地图样式、响应式布局。
- `js/utils.js`：地图工具函数（投影、绘制、坐标换算、距离计算等）。
- `js/game.js`：游戏状态机、题库生成、交互判题、成绩统计、持久化。

## 3. 页面与功能模块
### 3.1 首页
- 四种模式入口：
  - 省份大挑战
  - 省会定位
  - 世界国家挑战
  - 世界城市定位
- 难度选择：
  - 省份：简单/困难
  - 省会：简单/困难/超级
  - 世界国家：全部/Top50
  - 世界城市：Top50/Top200
- 游戏规则说明。
- 本地最佳成绩展示（`localStorage`）。

### 3.2 游戏页
- 题干与进度显示。
- 地图答题区（大尺寸、可缩放平移）。
- 操作区：
  - 主操作：下一题、返回首页
  - 辅助操作（默认隐藏，可切换显示）：倍率、重置、上下左右平移
- 开发日志面板（隐藏功能，用于问题复现和排查）。

### 3.3 结果页
- 成绩文案与统计信息。
- 地图复盘（省份题显示正确/错误高亮；城市题显示点击点、目标点与连线）。
- 历史答题表。
- 再来一局、分享挑战、返回首页。

## 4. 地图与数据处理设计
### 4.1 数据文件
- `data/china-provinces.geojson`
- `data/china-cities.json`
- `data/world-countries.geojson`
- `data/world-cities.json`
- `data/world-countries-full.json`（世界国家中英文映射来源）

### 4.2 数据清洗与标准化
- 中国省级 GeoJSON 做环向纠正（处理个别要素方向问题）。
- 世界国家过滤：
  - 过滤过小国家（面积阈值）
  - 按需求排除台湾
- 世界城市过滤：仅保留 capital/major 且坐标有效。
- 国家中英名称：基于 `world-countries-full.json` + `Intl.DisplayNames` + 别名映射。

### 4.3 中国底图拼装
中国模式的底图不是单纯使用一个外轮廓，而是组合：
1. 中国主轮廓（来自世界地图中的 China feature）
2. 台湾要素补充
3. 九段线要素补充（`adchar=JD` / `adcode=_JD`）

这样可保证：
- 地图整体轮廓稳定
- 台湾与九段线可见
- 同时可以在省份题隐藏省界线

## 5. 题库生成与难度策略
### 5.1 省份大挑战
- 从中国省级要素抽题。
- 过滤澳门（太小，影响可玩性）。
- 省份困难模式关闭悬停提示。

### 5.2 省会定位
- 简单：省会题库。
- 困难：隐藏省界、关闭悬停高亮。
- 超级：在省会题库基础上加入“第二大城市”题库。
- 为避免过于简单，排除直辖市/特别行政区/台湾相关项。
- 题干格式为“省级全名 + 城市全名”（如 `湖北省武汉市`）。

### 5.3 世界国家挑战
- 全部国家或 Top50（按地理面积排序）。
- 题干使用中英双语。

### 5.4 世界城市定位
- Top50 或 Top200。
- 题干中英双语，首都与主要城市分别标注。

## 6. 交互与判题引擎
### 6.1 统一指针状态机（重点）
- 使用 `pointerdown / pointerup / pointercancel`。
- 记录按下点、地图变换（平移/缩放）状态。
- 若检测到拖动/缩放/多指手势，豁免判题。
- 对触摸设备使用更宽松的移动阈值，避免误判拖动。

### 6.2 地图外点击保护
- 若点击不在任何有效 feature 内，不计错不跳题，仅提示用户。

### 6.3 省份类判定
- 优先使用事件命中 feature。
- 回退到 `geoContains`（根据点击经纬度搜索 feature），避免拖动后 target 丢失造成“点了没反应”。

### 6.4 城市类判定
- 使用 Haversine 球面距离计算真实误差（非屏幕平面距离）。
- 误差连线按地理路径绘制，减少跨经线视觉误差。

### 6.5 出题节奏
- 每局 10 题。
- 正确/错误均在 2 秒后自动进入下一题。

## 7. 视觉与响应式实现
- 地图区域在桌面端保持较大高度，避免“小图不易点”。
- 中国地图采用深色填充和清晰外轮廓。
- 省份困难/省会困难可隐藏省界线。
- 悬停高亮仅在支持 hover 的设备启用，减少手机端“高亮残留”。
- 工具栏支持移动端折叠（辅助键默认隐藏）。

## 8. 持久化与分享
- `localStorage` 保存：
  - 难度设置
  - 辅助键显示状态
  - 各模式最佳成绩
  - 开发日志开关
- 分享按钮可生成挑战文案和链接。

## 9. 质量保障
- Playwright 自动化测试覆盖：
  - 四模式基础流程
  - 地图渲染与交互
  - 结果页与历史表
  - 响应式视口
  - 数据加载与错误处理
- 日常回归命令：`npm test`

## 10. 版本与发布策略
- 页面显示版本号（首页/游戏页/结果页）。
- 静态资源采用查询参数版本（`?v=...`）做缓存失效。
- GitHub Actions + Pages 自动发布。

## 11. 已踩坑与解决方案总结
1. 中国地图只显示小块/九段线孤立：
- 原因：边界方向与拟合要素选择不当。
- 解决：几何方向修正 + 中国底图组合策略。

2. 点击总判成同一国家/同一省：
- 原因：仅依赖单一命中路径。
- 解决：事件命中 + 地理包含双路径判定。

3. 移动端拖动后点击失效：
- 原因：触控指针状态残留。
- 解决：主指针重置、cancel 清理、多指分支隔离。

4. 手机端高亮残留：
- 原因：触摸设备 hover 行为不稳定。
- 解决：仅在支持 hover 的设备启用 hover 高亮。
